# ==============================================================================
# Build Script Version: 3.3 (Smart Multi-Arch + Conditional Optimization)
# Date of Creation: February 26, 2026
# Description: Automated parallel build and packaging for ARM64 and MIPS(el)
# Features: 
#   - Parallel Matrix Build: aarch64, mipsel_24kc
#   - Smart Rust Compiler: Max speed for ARM64, Extreme size compression for MIPS
#   - IPK Build: All architectures (WITH mtime fix for 0x78 errors)
#   - APK Build: aarch64 ONLY (WITHOUT mtime fix)
#   - ZERO Dependencies: Relies on luci-app-telemt or firmware for certificates
# ==============================================================================

name: Build and Release Telemt

on:
  push:
    tags:
      - '3.0.1[3-9]'
      - '3.0.[2-9]*'
      - '3.[1-9]*'
      - '[4-9]*'
  
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Enter tag (e.g., 3.0.15) or branch (main)'
        required: true
        default: '3.0.15'

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    strategy:
      matrix:
        include:
          - target: aarch64-unknown-linux-musl
            archs: "aarch64_generic aarch64_cortex-a53"
          - target: mipsel-unknown-linux-musl
            archs: "mipsel_24kc"

    steps:
      - name: Extract version
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.build_target }}" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            echo "VERSION=nightly" >> $GITHUB_ENV
          fi

      - name: Checkout upstream repository
        uses: actions/checkout@v4
        with:
          repository: 'telemt/telemt'
          ref: ${{ env.VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross and nFPM
        run: |
          curl -sL https://github.com/cross-rs/cross/releases/latest/download/cross-x86_64-unknown-linux-musl.tar.gz | tar -xz
          sudo mv cross /usr/local/bin/
          
          NFPM_TAG=$(curl -sL https://api.github.com/repos/goreleaser/nfpm/releases/latest | jq -r .tag_name)
          NFPM_VER=${NFPM_TAG#v}
          curl -sL "https://github.com/goreleaser/nfpm/releases/download/${NFPM_TAG}/nfpm_${NFPM_VER}_Linux_x86_64.tar.gz" | tar -xz
          sudo mv nfpm /usr/local/bin/

      - name: Build binary with cross
        run: |
          # Включаем strip (удаление отладочных символов) для ВСЕХ архитектур
          export CARGO_PROFILE_RELEASE_STRIP="true"
          
          # Включаем экстремальное сжатие ТОЛЬКО для MIPS (экономим RAM/Flash)
          if [[ "${{ matrix.target }}" == *"mipsel"* ]]; then
            echo "Target is MIPS. Applying extreme size optimizations..."
            export CARGO_PROFILE_RELEASE_OPT_LEVEL="z"
            export CARGO_PROFILE_RELEASE_LTO="true"
            export CARGO_PROFILE_RELEASE_CODEGEN_UNITS="1"
            export CARGO_PROFILE_RELEASE_PANIC="abort"
          else
            echo "Target is ARM64. Using default high-performance profile..."
          fi
          
          cross build --release --target ${{ matrix.target }}

      - name: Install UPX
        run: sudo apt-get update && sudo apt-get install -y upx-ucl

      - name: Compress with UPX
        run: |
          upx --best --lzma target/${{ matrix.target }}/release/telemt

      - name: Append version string
        run: |
          echo -n "MTProxy v${{ env.VERSION }}" >> target/${{ matrix.target }}/release/telemt
          mv target/${{ matrix.target }}/release/telemt telemt-${{ matrix.target }}

      - name: Build IPK and APK packages with nFPM
        run: |
          export PKG_VER="${{ env.VERSION }}"
          
          cat > postinst.sh <<EOF
          #!/bin/sh
          echo ""
          echo "================================================================="
          echo " Installed telemt static executable version \${PKG_VER}"
          echo " "
          echo " To configure it, you need the following package:"
          echo " https://github.com/Medvedolog/luci-app-telemt"
          echo "================================================================="
          echo ""
          exit 0
          EOF
          chmod 755 postinst.sh

          ARCHS=(${{ matrix.archs }})
          
          for ARCH in "${ARCHS[@]}"; do
            export PKG_ARCH=$ARCH
            echo "Building packages for $PKG_ARCH..."
            
            # --- 1. IPK (Для всех архитектур, с фиксом времени 0x78) ---
            export SOURCE_DATE_EPOCH=1704067200
            cat > nfpm_ipk.yaml <<EOF
          name: telemt
          arch: $PKG_ARCH
          platform: linux
          version: $PKG_VER
          maintainer: Community
          description: Telemt MTProxy static binary (Built for $PKG_ARCH)
          contents:
            - src: ./telemt-${{ matrix.target }}
              dst: /usr/bin/telemt
              file_info:
                mode: 0755
                mtime: 2024-01-01T00:00:00Z
          scripts:
            postinstall: ./postinst.sh
          EOF
            nfpm pkg --config nfpm_ipk.yaml --packager ipk --target "telemt_${PKG_VER}_${PKG_ARCH}.ipk"
            
            # --- 2. APK (Только для aarch64, без фикса времени) ---
            if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
              unset SOURCE_DATE_EPOCH
              cat > nfpm_apk.yaml <<EOF
          name: telemt
          arch: $PKG_ARCH
          platform: linux
          version: $PKG_VER
          maintainer: Community
          description: Telemt MTProxy static binary (Built for $PKG_ARCH)
          contents:
            - src: ./telemt-${{ matrix.target }}
              dst: /usr/bin/telemt
              file_info:
                mode: 0755
          scripts:
            postinstall: ./postinst.sh
          EOF
              nfpm pkg --config nfpm_apk.yaml --packager apk --target "telemt_${PKG_VER}_${PKG_ARCH}.apk"
            else
              echo "Skipping APK generation for non-aarch64 target: $PKG_ARCH"
            fi
            
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          files: |
            telemt-${{ matrix.target }}
            *.ipk
            *.apk
          name: Release ${{ env.VERSION }}
          tag_name: ${{ env.VERSION }}
          prerelease: ${{ env.VERSION == 'main' || env.VERSION == 'master' }}
          draft: false
          append_body: true
