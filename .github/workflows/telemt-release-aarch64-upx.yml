name: Build Telemt aarch64

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag or branch to build (e.g., v3.0.13)'
        required: true
        type: string
        default: 'main'

jobs:
  build:
    name: Build Telemt aarch64-musl
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch full history & tags

      - name: Explicitly fetch all tags + specified ref
        run: |
          git fetch --prune --unshallow origin "+refs/tags/*:refs/tags/*" "+refs/heads/*:refs/remotes/origin/*"
          git fetch origin ${{ github.event.inputs.release_tag }} || true
          git checkout ${{ github.event.inputs.release_tag }}

      - name: Install Rust toolchain and target
        run: |
          rustup toolchain install stable
          rustup target add aarch64-unknown-linux-musl

      - name: Install musl cross tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools curl
          curl -fsSL https://musl.cc/aarch64-linux-musl-cross.tgz | tar xz -C /opt
          echo "/opt/aarch64-linux-musl-cross/bin" >> $GITHUB_PATH

      - name: Configure Cargo for musl
        run: |
          mkdir -p ~/.cargo
          printf "[target.aarch64-unknown-linux-musl]\nlinker = \"aarch64-linux-musl-gcc\"\n" >> ~/.cargo/config.toml

      - name: Build release binary
        run: |
          export CC_aarch64_unknown_linux_musl=aarch64-linux-musl-gcc
          export AR_aarch64_unknown_linux_musl=aarch64-linux-musl-ar
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=aarch64-linux-musl-gcc
          cargo build --release --target aarch64-unknown-linux-musl

      - name: Strip binary
        run: |
          aarch64-linux-musl-strip target/aarch64-unknown-linux-musl/release/telemt

      - name: Embed version tag into binary
        run: |
          VERSION="${{ github.event.inputs.release_tag }}"
          printf "\nTELEMT_VERSION=${VERSION}\n" >> target/aarch64-unknown-linux-musl/release/telemt

      - name: Install UPX
        run: |
          sudo apt-get update
          sudo apt-get install -y upx

      - name: Compress binary with UPX
        run: |
          upx --best --lzma target/aarch64-unknown-linux-musl/release/telemt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: telemt-aarch64
          path: target/aarch64-unknown-linux-musl/release/telemt
